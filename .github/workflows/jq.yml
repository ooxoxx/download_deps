name: jq on Ubuntu 24.04

on:
  workflow_dispatch: # 允许手动触发

jobs:
  # 第一步：在有网的环境下载依赖包
  download-dependencies:
    runs-on: ubuntu-24.04 # 必须使用与目标服务器相同的系统版本
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download jq and recursive dependencies
        run: |
          echo "创建下载目录..."
          mkdir -p ./offline-packages
          cd ./offline-packages

          echo "更新 apt 缓存..."
          sudo apt-get update

          echo "解析并下载 jq 及其所有依赖..."
          # 1. 获取所有递归依赖项列表 (排除建议和推荐包，只保留核心依赖)
          # 2. 过滤掉非包名的输出
          # 3. 排序并去重
          DEPS=$(apt-cache depends --recurse --no-replaces \
            --no-suggests --no-conflicts --no-breaks --no-enhances \
            --no-pre-depends jq | grep "^\w" | sort -u)
          
          echo "检测到的依赖列表: $DEPS"

          # 循环下载每一个包
          for pkg in $DEPS; do
            echo "正在下载: $pkg"
            apt-get download $pkg 2>/dev/null || echo "警告: 无法下载 $pkg (可能是虚拟包或已包含)"
          done

          # 确保下载 jq 本身
          apt-get download jq

          echo "下载完成。文件列表："
          ls -lh

      - name: Upload packages as artifact
        uses: actions/upload-artifact@v4
        with:
          name: jq-offline-bundle
          path: ./offline-packages/*.deb
          retention-days: 1
