name: Download Incremental Sahi Wheels (Ubuntu 24.04 / Py3.10)

on:
  workflow_dispatch: # 允许手动触发

jobs:
  download-sahi-delta:
    name: Download Incremental Wheels
    runs-on: ubuntu-24.04
    
    steps:
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # 1. 定义“基础环境”：即你已经拥有、不需要重复下载的包
      #    注意：这里去掉了 sahi，保留了其他所有原来的包
      - name: Create Base Requirements (Already Exists)
        run: |
          cat <<EOF > requirements-base.txt
          fastapi>=0.109.0
          uvicorn[standard]>=0.27.0
          python-multipart>=0.0.6
          opencv-python>=4.8.0
          numpy>=1.24.0
          pydantic>=2.0.0
          pydantic-settings>=2.0.0
          pytest>=7.0.0
          httpx>=0.25.0
          tqdm>=4.65.0
          ultralytics>=8.3.0
          torch>=2.0.0 
          torchvision>=0.15.0
          EOF

      # 2. 模拟现场环境：先安装基础包
      #    这是关键步骤。Pip 只有检测到包已安装，download 命令才会跳过它们。
      - name: Install Base Environment
        run: |
          echo "Simulating existing environment..."
          pip install -r requirements-base.txt

      # 3. 【新增步骤】验证环境
      #    如果这里报错，说明 torch 没装上，流水线会立即停止，防止后面下载 4GB 数据
      - name: Verify Installation (Gatekeeper)
        run: |
          echo "Verifying critical dependencies..."
          
          # 方法 A: 打印 pip 清单中 torch 的信息
          pip show torch | grep -E "Name|Version|Location"
          
          # 方法 B (更严谨): 尝试导入库，确保 Python 解释器能找到它
          python -c "import torch; print(f'SUCCESS: Found Torch {torch.__version__}')"
          python -c "import numpy; print(f'SUCCESS: Found Numpy {numpy.__version__}')"
          
          echo "Environment verification passed. Ready for incremental download."

      # 4. 执行增量下载
      #    此时 pip 已经知道环境里有 torch 了，所以只会下载 sahi 及其缺少的依赖
      - name: Download Sahi Only (Incremental)
        run: |
          mkdir wheels
          echo "Downloading only missing dependencies for Sahi..."
          pip download sahi>=0.11.0 -d wheels

      - name: Check Results
        run: ls -lh wheels/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sahi-incremental-wheels-ubuntu2404
          path: wheels/
          retention-days: 1
