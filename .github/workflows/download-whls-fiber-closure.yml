name: Download Incremental Sahi Wheels (Ubuntu 24.04 / Py3.10)

on:
  workflow_dispatch:

jobs:
  download-sahi-delta:
    name: Download Incremental Wheels
    runs-on: ubuntu-24.04
    
    steps:
      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Upgrade pip
        run: python -m pip install --upgrade pip

      # 1. 定义基础清单
      - name: Create Base Requirements
        run: |
          cat <<EOF > requirements-base.txt
          fastapi>=0.109.0
          uvicorn[standard]>=0.27.0
          python-multipart>=0.0.6
          opencv-python>=4.8.0
          numpy>=1.24.0
          pydantic>=2.0.0
          pydantic-settings>=2.0.0
          pytest>=7.0.0
          httpx>=0.25.0
          tqdm>=4.65.0
          torch>=2.0.0
          torchvision>=0.15.0
          EOF

      # 2. 安装基础环境 (CPU版本)
      - name: Install Base Environment (CPU Lightweight)
        run: |
          echo "Installing CPU versions of heavy libraries..."
          pip install -r requirements-base.txt --extra-index-url https://download.pytorch.org/whl/cpu

      # 3. 验证环境
      - name: Verify Installation (Gatekeeper)
        run: |
          echo "Verifying critical dependencies..."
          python -c "import torch; print(f'SUCCESS: Found Torch {torch.__version__}')"

      # 4. 执行增量下载
      - name: Download Sahi Only (Incremental)
        run: |
          mkdir wheels
          echo "Downloading only missing dependencies for Sahi..."
          pip download sahi>=0.11.0 -d wheels

      # 5. 【新增步骤】强制清理重型依赖 (Double Check)
      #    即使 pip 意外下载了它们，这一步也会将其抹除，确保 artifact 轻量化
      - name: Cleanup Heavy Wheels
        run: |
          echo "Performing final cleanup of heavy/unwanted wheels..."
          
          # 使用 -f 忽略“文件不存在”的错误
          # 清理目标：nvidia CUDA库, torch核心库, triton (torch依赖)
          rm -f wheels/nvidia_*.whl
          rm -f wheels/torch-*.whl
          rm -f wheels/torchvision-*.whl
          rm -f wheels/triton-*.whl
          
          echo "Cleanup complete."

      # 6. 检查最终结果
      - name: Check Final Artifact Content
        run: |
          echo "Final list of wheels to be uploaded:"
          ls -lh wheels/

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sahi-incremental-wheels-ubuntu2404
          path: wheels/
          retention-days: 1
