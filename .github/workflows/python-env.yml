name: Build Offline Env (Conda-Pack + Custom Pip)

on:
  workflow_dispatch:

jobs:
  build-and-pack:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Micromamba (Empty Python Env)
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: aiserv
          create-args: >
            python=3.10
            pip
            conda-pack
      - name: Install Dependencies (All in One)
        shell: bash -l {0}
        run: |
          micromamba activate aiserv
          
          # 关键点：
          # 1. 所有的包写在同一行。
          # 2. --index-url 指定为 PyTorch 的 cu130 源 (Pip 会优先在这里找 torch 和 torchvision)。
          # 3. --extra-index-url 指定为 PyPI (Pip 会在这里找 ultralytics, pandas 等)。
          # 4. 显式列出 torchvision，确保它也从 cu130 源下载。
          
          pip install \
            torch \
            torchvision \
            torchaudio \
            ultralytics \
            jupyterlab \
            numpy \
            pandas \
            scikit-learn \
            opencv-python-headless \
            --index-url https://download.pytorch.org/whl/cu130 \
            --extra-index-url https://pypi.org/simple

          # 验证安装结果（这步很重要，能让你在日志里看到最终版本）
          python -c "import torch; print(f'Final Torch Version: {torch.__version__}')"

      - name: Pack Environment
        shell: bash -l {0}
        run: |
          # 忽略一些非致命的软链接错误，保证打包成功
          conda-pack -n aiserv -o aiserv_hybrid.tar.gz --ignore-missing-files

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: aiserv-hybrid-pack
          path: aiserv_hybrid.tar.gz
          retention-days: 3
