name: Build Offline Env (Conda-Pack + Custom Pip)

on:
  workflow_dispatch:

jobs:
  build-and-pack:
    runs-on: ubuntu-24.04
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Micromamba (Empty Python Env)
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: aiserv
          create-args: >
            python=3.10
            pip
            conda-pack
            # 这里我们只安装基础工具，具体的库留给下面用 pip 安装
            # 这样可以保证所有库（包括 numpy）都与你的 pip 版 pytorch 兼容

      - name: Install Dependencies via Pip
        shell: bash -l {0}
        run: |
          micromamba activate aiserv
          
          echo "Installing PyTorch from Custom URL..."
          # --- 这里执行你指定的命令 ---
          pip install torch torchvision --index-url https://download.pytorch.org/whl/cu130
          
          echo "Installing other dependencies..."
          # 安装其他依赖
          # 注意：在无头服务器(headless)推荐使用 opencv-python-headless
          pip install ultralytics jupyterlab numpy pandas scikit-learn opencv-python-headless

          # 清理缓存减小体积
          pip cache purge
          conda clean -a -y

      - name: Pack Environment
        shell: bash -l {0}
        run: |
          # 忽略一些非致命的软链接错误，保证打包成功
          conda-pack -n aiserv -o aiserv_hybrid.tar.gz --ignore-missing-files

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: aiserv-hybrid-pack
          path: aiserv_hybrid.tar.gz
          retention-days: 3
