name: Build Offline Env (Windows + Conda-Pack)

on:
  workflow_dispatch:

jobs:
  build-and-pack:
    runs-on: windows-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Micromamba
        uses: mamba-org/setup-micromamba@v1
        with:
          environment-name: aiserv
          create-args: >-
            python=3.10
            pip
            conda-pack

      - name: Install Dependencies (Windows Pip)
        shell: pwsh
        run: |
          # 在 Windows 下建议直接调用 micromamba run 或者在激活的环境中执行
          micromamba run -n aiserv pip install `
            torch `
            torchvision `
            torchaudio `
            ultralytics `
            jupyterlab `
            numpy `
            pandas `
            scikit-learn `
            opencv-python-headless `
            --extra-index-url https://pypi.org/simple

          # 验证安装
          micromamba run -n aiserv python -c "import torch; print(f'Final Torch Version: {torch.__version__}')"

      - name: Pack Environment
        shell: pwsh
        run: |
          # 1. 获取环境的物理路径
          $env_path = "${{ env.MAMBA_ROOT_PREFIX }}\envs\aiserv"
          
          # 2. 直接针对路径进行打包，而不是针对环境名称
          # 使用 -p (prefix) 代替 -n (name)
          micromamba run -n aiserv conda-pack `
            -p $env_path `
            -o aiserv_windows_offline.zip `
            --ignore-missing-files
            
      - name: Release
        uses: softprops/action-gh-release@v1
        # 修改这里：支持手动触发或标签触发
        if: github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')
        with:
          # 给发布的版本起个名字，防止手动运行时找不到 tag 报错
          tag_name: "manual-build-${{ github.run_number }}"
          name: "Offline Env Windows (Build ${{ github.run_number }})"
          files: aiserv_windows_offline.zip
          body: |
            Windows 离线环境包自动构建完成。
            Python: 3.10
            Torch Index: cu130
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
